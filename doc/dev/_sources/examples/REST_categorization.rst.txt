

.. _sphx_glr_examples_REST_categorization.py:


Categorization Example [REST API]
---------------------------------

An example to illustrate binary categorizaiton with FreeDiscovery





.. rst-class:: sphx-glr-script-out

 Out::

    0. Load the example dataset
     GET http://localhost:5001/api/v0/example-dataset/treclegal09_2k_subset

    1.a Load dataset and initalize feature extraction
     POST http://localhost:5001/api/v0/feature-extraction
       => received [u'id', u'filenames']
       => dsid = 7704e50ca1ed4df1

    1.b Start feature extraction (in the background)
     POST http://localhost:5001/api/v0/feature-extraction/7704e50ca1ed4df1

    1.c Monitor feature extraction progress
     GET http://localhost:5001/api/v0/feature-extraction/7704e50ca1ed4df1

    1.d. check the parameters of the extracted features
     GET http://localhost:5001/api/v0/feature-extraction/7704e50ca1ed4df1
         - binary: False
         - n_jobs: 1
         - data_dir: ../freediscovery_shared/treclegal09_2k_subset/data/jobRun_4/XML_EXPORT_CONTENT/text_9
         - use_hashing: True
         - min_df: 0.0
         - analyzer: word
         - n_samples: 2465
         - ngram_range: [1, 1]
         - max_df: 1.0
         - chunk_size: 5000
         - use_idf: False
         - stop_words: None
         - n_features: 100001
         - n_samples_processed: 2465
         - sublinear_tf: True
         - norm: None

    2. Calculate LSI
    POST http://localhost:5001/api/v0/lsi/
      => LSI model id = 80fd27a0c6cd4cc0
      => SVD decomposition with 100 dimensions explaining 99.79 % variabilty of the data

    3.a. Train the categorization model
       5 relevant, 63 non-relevant files
    ================================================================================ 
                LinearSVC   
     ================================================================================
     POST http://localhost:5001/api/v0/categorization/
     Training...
         => model id = 24a4cb41dc924361
        => Training scores: MAP = 0.537, ROC-AUC = 0.500, F1= 0.000

    3.b. Check the parameters used in the categorization model
     GET http://localhost:5001/api/v0/categorization/24a4cb41dc924361
         - y: [1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
         - method: LinearSVC
         - options: {'loss': 'squared_hinge', 'C': 1.0, 'verbose': 0, 'intercept_scaling': 1, 'fit_intercept': True, 'max_iter': 1000, 'penalty': 'l2', 'multi_class': 'ovr', 'random_state': None, 'dual': True, 'tol': 0.0001, 'class_weight': None}

    3.c Categorize the complete dataset with this model
     GET http://localhost:5001/api/v0/categorization/24a4cb41dc924361/predict
                 document_id                                           scores
    internal_id                                                              
    0                      0  [{u'category': u'0', u'score': 0.699664799519}]
    1                      1  [{u'category': u'0', u'score': 0.699724320238}]
    2                      2  [{u'category': u'0', u'score': 0.699663249198}]
    3                      3  [{u'category': u'0', u'score': 0.699662266124}]
    4                      4  [{u'category': u'0', u'score': 0.699663857536}]
    5                      5  [{u'category': u'0', u'score': 0.699663193111}]
    6                      6   [{u'category': u'0', u'score': 0.69966308374}]
    7                      7  [{u'category': u'0', u'score': 0.699663225664}]
    8                      8  [{u'category': u'0', u'score': 0.699663167172}]
    9                      9  [{u'category': u'0', u'score': 0.699663223812}]
    10                    10  [{u'category': u'0', u'score': 0.699662976244}]
    11                    11  [{u'category': u'0', u'score': 0.699746887683}]
    12                    12    [{u'category': u'0', u'score': 0.6997365651}]
    13                    13  [{u'category': u'0', u'score': 0.699885607391}]
    14                    14  [{u'category': u'0', u'score': 0.699703417362}]
    15                    15  [{u'category': u'0', u'score': 0.699665109899}]
    16                    16  [{u'category': u'0', u'score': 0.699899910715}]
    17                    17  [{u'category': u'0', u'score': 0.699795895656}]
    18                    18  [{u'category': u'0', u'score': 0.699702321527}]
    19                    19  [{u'category': u'0', u'score': 0.699726564878}]
    20                    20  [{u'category': u'0', u'score': 0.699666036551}]
    21                    21  [{u'category': u'0', u'score': 0.699964616301}]
    22                    22  [{u'category': u'0', u'score': 0.699736010196}]
    23                    23  [{u'category': u'0', u'score': 0.699735717857}]
    24                    24  [{u'category': u'0', u'score': 0.699681718499}]
    25                    25   [{u'category': u'0', u'score': 0.70001779267}]
    26                    26  [{u'category': u'0', u'score': 0.699807393155}]
    27                    27  [{u'category': u'0', u'score': 0.699726764614}]
    28                    28  [{u'category': u'0', u'score': 0.699949173514}]
    29                    29  [{u'category': u'0', u'score': 0.699802853335}]
    ...                  ...                                              ...
    2435                2435  [{u'category': u'0', u'score': 0.700266667376}]
    2436                2436  [{u'category': u'0', u'score': 0.699664265227}]
    2437                2437  [{u'category': u'0', u'score': 0.699664541833}]
    2438                2438   [{u'category': u'0', u'score': 0.69966351027}]
    2439                2439  [{u'category': u'0', u'score': 0.699663562076}]
    2440                2440  [{u'category': u'0', u'score': 0.699663838682}]
    2441                2441  [{u'category': u'0', u'score': 0.699663310491}]
    2442                2442  [{u'category': u'0', u'score': 0.699663587097}]
    2443                2443  [{u'category': u'0', u'score': 0.699663709099}]
    2444                2444  [{u'category': u'0', u'score': 0.699663985705}]
    2445                2445   [{u'category': u'0', u'score': 0.69966331832}]
    2446                2446  [{u'category': u'0', u'score': 0.699663594927}]
    2447                2447  [{u'category': u'0', u'score': 0.699662864449}]
    2448                2448  [{u'category': u'0', u'score': 0.699663141056}]
    2449                2449  [{u'category': u'0', u'score': 0.699663082723}]
    2450                2450  [{u'category': u'0', u'score': 0.699663284972}]
    2451                2451   [{u'category': u'0', u'score': 0.69966976269}]
    2452                2452  [{u'category': u'0', u'score': 0.699670039294}]
    2453                2453  [{u'category': u'0', u'score': 0.699665658145}]
    2454                2454   [{u'category': u'0', u'score': 0.69966593475}]
    2455                2455  [{u'category': u'0', u'score': 0.699666240533}]
    2456                2456  [{u'category': u'0', u'score': 0.699662858447}]
    2457                2457   [{u'category': u'0', u'score': 0.69966645826}]
    2458                2458  [{u'category': u'0', u'score': 0.699663076176}]
    2459                2459  [{u'category': u'0', u'score': 0.699694461016}]
    2460                2460  [{u'category': u'0', u'score': 0.699666015809}]
    2461                2461  [{u'category': u'0', u'score': 0.699711917957}]
    2462                2462  [{u'category': u'0', u'score': 0.699693604714}]
    2463                2463  [{u'category': u'0', u'score': 0.699682358871}]
    2464                2464  [{u'category': u'0', u'score': 0.699724034587}]

    [2465 rows x 2 columns]
    ================================================================================ 
                NearestNeighbor  + LSI 
     ================================================================================
     POST http://localhost:5001/api/v0/categorization/
     Training...
         => model id = 82efb5a1a6b54746
        => Training scores: MAP = 1.000, ROC-AUC = 1.000, F1= 1.000

    3.b. Check the parameters used in the categorization model
     GET http://localhost:5001/api/v0/categorization/82efb5a1a6b54746
         - y: [1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
         - method: NearestNeighbor
         - options: {'n_jobs': 1, 'radius': None, 'leaf_size': 30, 'algorithm': u'brute'}

    3.c Categorize the complete dataset with this model
     GET http://localhost:5001/api/v0/categorization/82efb5a1a6b54746/predict
                 document_id                                             scores
    internal_id                                                                
    0                      0  [{u'category': u'1', u'score': 0.914783134837,...
    1                      1  [{u'category': u'0', u'score': 0.341194765769,...
    2                      2  [{u'category': u'0', u'score': 0.988202559805,...
    3                      3  [{u'category': u'1', u'score': 1.0, u'internal...
    4                      4  [{u'category': u'1', u'score': 0.971132061684,...
    5                      5  [{u'category': u'1', u'score': 0.983426184133,...
    6                      6  [{u'category': u'1', u'score': 0.975598366372,...
    7                      7  [{u'category': u'1', u'score': 0.987956006553,...
    8                      8  [{u'category': u'0', u'score': 0.984428596715,...
    9                      9  [{u'category': u'0', u'score': 1.0, u'internal...
    10                    10  [{u'category': u'1', u'score': 0.995684779283,...
    11                    11  [{u'category': u'0', u'score': 0.34324401371, ...
    12                    12  [{u'category': u'0', u'score': 0.312620565406,...
    13                    13  [{u'category': u'0', u'score': 0.299137601983,...
    14                    14  [{u'category': u'0', u'score': 0.986463957756,...
    15                    15  [{u'category': u'0', u'score': 0.903850805402,...
    16                    16  [{u'category': u'0', u'score': 0.152787118579,...
    17                    17  [{u'category': u'0', u'score': 0.261417576815,...
    18                    18  [{u'category': u'0', u'score': 0.673798198571,...
    19                    19  [{u'category': u'0', u'score': 0.652174712428,...
    20                    20  [{u'category': u'0', u'score': 0.904942426095,...
    21                    21  [{u'category': u'0', u'score': 0.738418798736,...
    22                    22  [{u'category': u'0', u'score': 0.401681576567,...
    23                    23  [{u'category': u'0', u'score': 0.420722212672,...
    24                    24  [{u'category': u'0', u'score': 0.666209831481,...
    25                    25  [{u'category': u'0', u'score': 0.270310846579,...
    26                    26  [{u'category': u'0', u'score': 0.28814357633, ...
    27                    27  [{u'category': u'0', u'score': 0.495724935707,...
    28                    28  [{u'category': u'0', u'score': 0.180280609901,...
    29                    29  [{u'category': u'0', u'score': 0.244890649396,...
    ...                  ...                                                ...
    2435                2435  [{u'category': u'0', u'score': 0.154198781989,...
    2436                2436  [{u'category': u'1', u'score': 0.976304896591,...
    2437                2437  [{u'category': u'0', u'score': 0.90348136163, ...
    2438                2438  [{u'category': u'0', u'score': 0.916215351381,...
    2439                2439  [{u'category': u'0', u'score': 0.984150574029,...
    2440                2440  [{u'category': u'0', u'score': 0.929780477574,...
    2441                2441  [{u'category': u'0', u'score': 0.983209726037,...
    2442                2442  [{u'category': u'0', u'score': 0.923554302246,...
    2443                2443  [{u'category': u'1', u'score': 0.968034679661,...
    2444                2444  [{u'category': u'0', u'score': 0.890529681813,...
    2445                2445  [{u'category': u'1', u'score': 0.966115290488,...
    2446                2446  [{u'category': u'0', u'score': 0.904076138735,...
    2447                2447  [{u'category': u'1', u'score': 0.980514537285,...
    2448                2448  [{u'category': u'0', u'score': 0.93747634969, ...
    2449                2449  [{u'category': u'1', u'score': 0.99487979597, ...
    2450                2450  [{u'category': u'0', u'score': 0.91924580793, ...
    2451                2451  [{u'category': u'0', u'score': 1.0, u'internal...
    2452                2452  [{u'category': u'0', u'score': 0.888464168226,...
    2453                2453  [{u'category': u'0', u'score': 0.953483326732,...
    2454                2454  [{u'category': u'0', u'score': 0.833852594151,...
    2455                2455  [{u'category': u'0', u'score': 0.96402151695, ...
    2456                2456  [{u'category': u'1', u'score': 0.997040113042,...
    2457                2457  [{u'category': u'0', u'score': 0.909682375384,...
    2458                2458  [{u'category': u'1', u'score': 0.981762520832,...
    2459                2459  [{u'category': u'0', u'score': 0.922053254146,...
    2460                2460  [{u'category': u'0', u'score': 0.657943307113,...
    2461                2461  [{u'category': u'0', u'score': 0.627715149984,...
    2462                2462  [{u'category': u'0', u'score': 0.600586030428,...
    2463                2463  [{u'category': u'0', u'score': 0.549994515553,...
    2464                2464  [{u'category': u'0', u'score': 0.608037227874,...

    [2465 rows x 2 columns]

    5.a Delete the extracted features (and LSI decomposition)
     DELETE http://localhost:5001/api/v0/feature-extraction/7704e50ca1ed4df1




|


.. code-block:: python


    from __future__ import print_function

    from time import time, sleep
    from multiprocessing import Process
    import requests
    import pandas as pd

    pd.options.display.float_format = '{:,.3f}'.format
    pd.options.display.expand_frame_repr = False

    dataset_name = "treclegal09_2k_subset"     # see list of available datasets

    BASE_URL = "http://localhost:5001/api/v0"  # FreeDiscovery server URL

    if __name__ == '__main__':

        print(" 0. Load the example dataset")
        url = BASE_URL + '/example-dataset/{}'.format(dataset_name)
        print(" GET", url)
        res = requests.get(url, json={'return_file_path': True}).json()

        # To use a custom dataset, simply specify the following variables
        seed_document_id = res['seed_document_id']
        seed_y = res['seed_y']
        ground_truth_y = res['ground_truth_y']

        # create a custom dataset definition for ingestion
        dataset_definition = []
        for document_id, fname in zip(res['document_id'], res['file_path']):
            dataset_definition.append({'document_id': document_id,
                                      'rendering_id': 0,
                                      'file_path': fname})

        # 1. Feature extraction

        print("\n1.a Load dataset and initalize feature extraction")
        url = BASE_URL + '/feature-extraction'
        print(" POST", url)
        res = requests.post(url, json={'dataset_definition': dataset_definition,
                                       'use_hashing': True}).json()

        dsid = res['id']
        print("   => received {}".format(list(res.keys())))
        print("   => dsid = {}".format(dsid))

        print("\n1.b Start feature extraction (in the background)")

        # Make this call in a background process (there should be a better way of doing it)
        url = BASE_URL+'/feature-extraction/{}'.format(dsid)
        print(" POST", url)
        p = Process(target=requests.post, args=(url,))
        p.start()
        sleep(5.0) # wait a bit for the processing to start

        print('\n1.c Monitor feature extraction progress')
        url = BASE_URL+'/feature-extraction/{}'.format(dsid)
        print(" GET", url)

        t0 = time()
        while True:
            res = requests.get(url)
            if res.status_code == 520:
                p.terminate()
                raise ValueError('Processing did not start')
            elif res.status_code == 200:
                break # processing finished
            data = res.json()
            print('     ... {}k/{}k files processed in {:.1f} min'.format(
                        data['n_samples_processed']//1000, data['n_samples']//1000, (time() - t0)/60.))
            sleep(15.0)

        p.terminate()  # just in case, should not be necessary


        print("\n1.d. check the parameters of the extracted features")
        url = BASE_URL + '/feature-extraction/{}'.format(dsid)
        print(' GET', url)
        res = requests.get(url).json()

        print('\n'.join(['     - {}: {}'.format(key, val) for key, val in res.items() \
                                                          if "filenames" not in key]))
        # this step is not necessary anymore
        #method = BASE_URL + "/feature-extraction/{}/id-mapping/flat".format(dsid)
        #res = requests.get(method, data={'document_id': seed_document_id})
        #seed_internal_id = res.json()['internal_id']


        # 3. Document categorization with LSI (used for Nearest Neighbors method)

        print("\n2. Calculate LSI")

        url = BASE_URL + '/lsi/'
        print("POST", url)

        n_components = 100
        res = requests.post(url,
                            json={'n_components': n_components,
                                  'parent_id': dsid
                                  }).json()

        lsi_id = res['id']
        print('  => LSI model id = {}'.format(lsi_id))
        print('  => SVD decomposition with {} dimensions explaining {:.2f} % variabilty of the data'.format(
                                n_components, res['explained_variance']*100))


        # 3. Document categorization

        print("\n3.a. Train the categorization model")
        print("   {} relevant, {} non-relevant files".format(seed_y.count(1), seed_y.count(0)))

        seed_index_nested = [{'document_id': internal_id, 'category': y} \
                                    for internal_id, y in zip(seed_document_id, seed_y)]

        for method, use_lsi in [('LinearSVC', False),
                                ('NearestNeighbor', True)]:

            print('='*80, '\n', ' '*10,
                  method, " + LSI" if use_lsi else ' ', '\n', '='*80)
            if use_lsi:
                # Categorization with the previously created LSI model
                parent_id = lsi_id
            else:
                # Categorization with original text features
                parent_id = dsid

            url = BASE_URL + '/categorization/'
            print(" POST", url)
            print(' Training...')

            res = requests.post(url,
                                json={'parent_id': parent_id,
                                      'data': seed_index_nested,
                                      'method': method,  # one of "LinearSVC", "LogisticRegression", 'xgboost'
                                      }).json()

            mid = res['id']
            print("     => model id = {}".format(mid))
            print('    => Training scores: MAP = {average_precision:.3f}, ROC-AUC = {roc_auc:.3f}, F1= {f1:.3f}'.format(**res))

            print("\n3.b. Check the parameters used in the categorization model")
            url = BASE_URL + '/categorization/{}'.format(mid)
            print(" GET", url)
            res = requests.get(url).json()

            print('\n'.join(['     - {}: {}'.format(key, val) for key, val in res.items() \
                                                              if key not in ['index', 'category']]))

            print("\n3.c Categorize the complete dataset with this model")
            url = BASE_URL + '/categorization/{}/predict'.format(mid)
            print(" GET", url)
            res = requests.get(url).json()

            if method == "NearestNeighbor":
                data = res['data']
            else:
                data = res['data']

            df = pd.DataFrame(data).set_index('internal_id')
            #if method == "NearestNeighbor":
            #    df = df[['document_id', 'nn_negative__distance', 'nn_negative__document_id',
            #          'nn_positive__distance', 'nn_positive__document_id', 'score']]

            print(df)

            #print("\n3.d Compute the categorization scores")
            #url = BASE_URL + '/metrics/categorization'
            #print(" GET", url)
            #res = requests.post(url, json={'y_true': ground_truth_y,
            #                              'y_pred': df.score.values.tolist(),
            #                             } ).json()


            #print('    => Test scores: MAP = {average_precision:.3f}, ROC-AUC = {roc_auc:.3f}'.format(**res))

        # 4. Cleaning
        print("\n5.a Delete the extracted features (and LSI decomposition)")
        url = BASE_URL + '/feature-extraction/{}'.format(dsid)
        print(" DELETE", url)
        requests.delete(url)

**Total running time of the script:** ( 0 minutes  57.170 seconds)



.. container:: sphx-glr-footer


  .. container:: sphx-glr-download

     :download:`Download Python source code: REST_categorization.py <REST_categorization.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: REST_categorization.ipynb <REST_categorization.ipynb>`

.. rst-class:: sphx-glr-signature

    `Generated by Sphinx-Gallery <http://sphinx-gallery.readthedocs.io>`_
