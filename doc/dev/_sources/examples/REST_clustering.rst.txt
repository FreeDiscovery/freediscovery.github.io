

.. _sphx_glr_examples_REST_clustering.py:


Clustering Example [REST API]
-----------------------------

Cluster documents into clusters





.. rst-class:: sphx-glr-script-out

 Out::

    0. Load the example dataset
     GET http://localhost:5001/api/v0/example-dataset/treclegal09_2k_subset

    1.a Load dataset and initalize feature extraction
     POST http://localhost:5001/api/v0/feature-extraction
       => received ['id']
       => dsid = 5246e3effde24f6d

    1.b Run feature extraction
     POST http://localhost:5001/api/v0/feature-extraction/5246e3effde24f6d

    1.d. check the parameters of the extracted features
     GET http://localhost:5001/api/v0/feature-extraction/5246e3effde24f6d
         - analyzer: word
         - binary: False
         - chunk_size: 5000
         - data_dir: /home/ubuntu/freediscovery_shared/treclegal09_2k_subset/data/jobRun_4/XML_EXPORT_CONTENT/text_9
         - max_df: 1.0
         - min_df: 0.0
         - n_features: 100001
         - n_jobs: 1
         - n_samples: 2465
         - n_samples_processed: 2465
         - ngram_range: [1, 1]
         - norm: l2
         - parse_email_headers: False
         - stop_words: None
         - sublinear_tf: True
         - use_hashing: False
         - use_idf: False

    2. Calculate LSI
    POST http://localhost:5001/api/v0/lsi/
      => LSI model id = 5587ad9e86b04b7d
      => SVD decomposition with 300 dimensions explaining 90.00 % variabilty of the data

    3.a. Document clustering (LSI + K-means)
     POST http://localhost:5001/api/v0/clustering/k-mean/
         => model id = e1465f839b644c13

    3.b. Computing cluster labels
     GET http://localhost:5001/api/v0/clustering/k-mean/e1465f839b644c13
        .. computed in 1.2s
       cluster_id                      cluster_label  cluster_similarity  cluster_size  n_documents
    0           0  enron_development normal november               0.144           345          345
    1           1                  office normal nov               0.201           230          230
    2           2                     normal oct fri               0.291           164          164
    3           3                   lunch normal thu               0.181           244          244
    4           4               shall agreement swap               0.456            79           79
    5           5             rewrite address server               1.000            56           56
    6           6           transaction party period               0.581            47           47
    7           7          test teneo administrative               0.174           292          292
    8           8                   tenet tue normal               0.224           195          195
    9           9                      ect hou sager               0.088           813          813

    4.a. Document clustering (LSI + Birch clustering)
     POST http://localhost:5001/api/v0/clustering/birch/
         => model id = 92838af2dff543a4

    4.b. Computing cluster labels
     GET http://localhost:5001/api/v0/clustering/birch/92838af2dff543a4
        .. computed in 2.2s
                                                 children  cluster_depth  cluster_id                        cluster_label  cluster_similarity  cluster_size  n_documents
    0   [1, 3, 6, 8, 10, 15, 20, 23, 27, 31, 34, 38, 4...              0           0                      normal test ect               0.071          2465         2465
    1                                                 [2]              1           1               rewrite address server               0.773            73           73
    2                                                  []              2           2               rewrite address server               0.773            73           73
    3                                              [4, 5]              1           3      enron_development committee esa               0.364            49           49
    4                                                  []              2           4      enron_development committee esa               0.508            31           31
    5                                                  []              2           5                 class guaranty deals               0.424            18           18
    6                                                 [7]              1           6                  test bruno gaillard               0.719             3            3
    7                                                  []              2           7                  test bruno gaillard               0.719             3            3
    8                                                 [9]              1           8             harris account brokerage               0.482            27           27
    9                                                  []              2           9             harris account brokerage               0.482            27           27
    10                                   [11, 12, 13, 14]              1          10                    shall lessee calo               0.209           149          149
    11                                                 []              2          11                   tiger sekse brazil               0.470            19           19
    12                                                 []              2          12          shackleton library davidson               0.375            27           27
    13                                                 []              2          13                    isda project poon               0.315            40           40
    14                                                 []              2          14                    shall lessee calo               0.383            63           63
    15                                   [16, 17, 18, 19]              1          15                kean nemec shackleton               0.202           152          152
    16                                                 []              2          16                    deal muni aquilla               0.468            26           26
    17                                                 []              2          17                 shackleton load duke               0.441            25           25
    18                                                 []              2          18                     nemec doc gallup               0.323            54           54
    19                                                 []              2          19                      kean dupre test               0.360            47           47
    20                                           [21, 22]              1          20                  advice deseret know               0.312            54           54
    21                                                 []              2          21              advice deseret etringer               0.417            37           37
    22                                                 []              2          22                   nemec legal credit               0.379            17           17
    23                                       [24, 25, 26]              1          23                    teneo normal load               0.456            75           75
    24                                                 []              2          24      performance management dasovich               0.507            10           10
    25                                                 []              2          25                     teneo normal fri               0.573            32           32
    26                                                 []              2          26                      load teneo meet               0.510            33           33
    27                                       [28, 29, 30]              1          27               transaction party test               0.242           183          183
    28                                                 []              2          28               party test transaction               0.362            98           98
    29                                                 []              2          29    period determination confirmation               0.490            22           22
    ..                                                ...            ...         ...                                  ...                 ...           ...          ...
    64                                                 []              2          64              project clair financial               0.317            24           24
    65                                                 []              2          65             murray eb3325 mccullough               0.460            17           17
    66                                                 []              2          66               team outlook migration               0.326            26           26
    67                               [68, 69, 70, 71, 72]              1          67                     tenet normal mon               0.285           148          148
    68                                                 []              2          68                        wed tenet nov               0.460            14           14
    69                                                 []              2          69                     tenet wed normal               0.367            53           53
    70                                                 []              2          70                    tenet fri meeting               0.394            30           30
    71                                                 []              2          71                        tenet tue mon               0.436            22           22
    72                                                 []              2          72                        mon tenet nov               0.448            29           29
    73  [74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 8...              1          73                     normal tenet mtg               0.117           570          570
    74                                                 []              2          74           sample agreements malowney               0.504            13           13
    75                                                 []              2          75                attorney master south               0.411            26           26
    76                                                 []              2          76               resume mirari barriola               0.992             4            4
    77                                                 []              2          77              derivatives report hyvl               0.434            27           27
    78                                                 []              2          78                       alias usvi fyi               0.408            26           26
    79                                                 []              2          79              meeting davis financial               0.387            21           21
    80                                                 []              2          80                 conference tenet thu               0.405            35           35
    81                                                 []              2          81                   office meeting lon               0.399            29           29
    82                                                 []              2          82              confirmation black hour               0.373            11           11
    83                                                 []              2          83                         thu list oct               0.355            42           42
    84                                                 []              2          84               team outlook migration               0.309            47           47
    85                                                 []              2          85                    bockius sat lunch               0.359            22           22
    86                                                 []              2          86  conference shackleton_sara dasovich               0.324            45           45
    87                                                 []              2          87                       master gtc eta               0.361            44           44
    88                                                 []              2          88                kincannon budget room               0.374            33           33
    89                                                 []              2          89            sager haedicke labanowski               0.414            26           26
    90                                                 []              2          90                mtg migration outlook               0.441            42           42
    91                                                 []              2          91                       mtg mon update               0.550            18           18
    92                                                 []              2          92                      letter work tue               0.316            37           37
    93                                                 []              2          93                        thu nov tenet               0.397            22           22

    [94 rows x 7 columns]

    4.a. Optimal sampling (LSI + Birch clustering)
     GET http://localhost:5001/api/v0/clustering/birch/92838af2dff543a4
        .. computed in 0.1s
        cluster_id  cluster_similarity  cluster_size                                          documents
    0           28               0.362            98  [{'document_id': 165649, 'similarity': 0.63678...
    1           50               0.407            76  [{'document_id': 11236, 'similarity': 0.811308...
    2            2               0.773            73  [{'document_id': 5041, 'similarity': 0.9920516...
    3           47               0.369            73  [{'document_id': 609961, 'similarity': 0.81484...
    4           14               0.383            63  [{'document_id': 1567504, 'similarity': 0.7316...
    5           30               0.300            63  [{'document_id': 91809, 'similarity': 0.556389...
    6           18               0.323            54  [{'document_id': 710649, 'similarity': 0.57306...
    7           44               0.347            53  [{'document_id': 131769, 'similarity': 0.76388...
    8           69               0.367            53  [{'document_id': 2313441, 'similarity': 0.6288...
    9           59               0.372            52  [{'document_id': 2676496, 'similarity': 0.6157...
    10          46               0.352            49  [{'document_id': 142884, 'similarity': 0.58471...
    11          37               0.326            48  [{'document_id': 552049, 'similarity': 0.54774...
    12          19               0.360            47  [{'document_id': 162409, 'similarity': 0.63476...
    13          84               0.309            47  [{'document_id': 5982916, 'similarity': 0.4938...
    14          63               0.302            45  [{'document_id': 2059225, 'similarity': 0.5921...
    15          86               0.324            45  [{'document_id': 4774225, 'similarity': 0.5375...
    16          87               0.361            44  [{'document_id': 1098304, 'similarity': 0.6449...
    17          60               0.346            42  [{'document_id': 242064, 'similarity': 0.49933...
    18          83               0.355            42  [{'document_id': 2223081, 'similarity': 0.6182...
    19          90               0.441            42  [{'document_id': 5452225, 'similarity': 0.6026...
    20          32               0.353            41  [{'document_id': 1934881, 'similarity': 0.5735...
    21          13               0.315            40  [{'document_id': 202500, 'similarity': 0.46883...
    22          42               0.421            40  [{'document_id': 3984016, 'similarity': 0.5660...
    23          45               0.375            39  [{'document_id': 4624, 'similarity': 0.7378626...
    24          21               0.417            37  [{'document_id': 234256, 'similarity': 0.62456...
    25          92               0.316            37  [{'document_id': 2715904, 'similarity': 0.5905...
    26          48               0.348            36  [{'document_id': 756900, 'similarity': 0.62069...
    27          80               0.405            35  [{'document_id': 1493284, 'similarity': 0.7536...
    28          26               0.510            33  [{'document_id': 350464, 'similarity': 0.65889...
    29          41               0.453            33  [{'document_id': 1317904, 'similarity': 0.6514...
    30          88               0.374            33  [{'document_id': 2647129, 'similarity': 0.6212...
    31          25               0.573            32  [{'document_id': 358801, 'similarity': 0.72548...
    32           4               0.508            31  [{'document_id': 33124, 'similarity': 0.780362...
    33          70               0.394            30  [{'document_id': 5607424, 'similarity': 0.6511...
    34          51               0.331            29  [{'document_id': 363609, 'similarity': 0.47628...
    35          55               0.364            29  [{'document_id': 5929225, 'similarity': 0.6133...
    36          72               0.448            29  [{'document_id': 6041764, 'similarity': 0.6959...
    37          81               0.399            29  [{'document_id': 1885129, 'similarity': 0.5949...
    38           9               0.482            27  [{'document_id': 4609609, 'similarity': 0.7327...
    39          12               0.375            27  [{'document_id': 69696, 'similarity': 0.548854...
    40          53               0.380            27  [{'document_id': 1404225, 'similarity': 0.7233...
    41          57               0.354            27  [{'document_id': 1155625, 'similarity': 0.5265...
    42          77               0.434            27  [{'document_id': 1119364, 'similarity': 0.7353...
    43          16               0.468            26  [{'document_id': 7225, 'similarity': 0.7724612...
    44          66               0.326            26  [{'document_id': 3378244, 'similarity': 0.5019...
    45          75               0.411            26  [{'document_id': 36481, 'similarity': 0.687659...
    46          78               0.408            26  [{'document_id': 3667225, 'similarity': 0.7688...
    47          89               0.414            26  [{'document_id': 992016, 'similarity': 0.61040...
    48          17               0.441            25  [{'document_id': 61504, 'similarity': 0.673714...
    49          56               0.361            25  [{'document_id': 1042441, 'similarity': 0.7228...
    50          62               0.328            24  [{'document_id': 1943236, 'similarity': 0.4214...
    51          64               0.317            24  [{'document_id': 1382976, 'similarity': 0.5059...
    52          29               0.490            22  [{'document_id': 54756, 'similarity': 0.876469...
    53          33               0.411            22  [{'document_id': 2005056, 'similarity': 0.6232...
    54          61               0.360            22  [{'document_id': 1002001, 'similarity': 0.5906...
    55          71               0.436            22  [{'document_id': 1893376, 'similarity': 0.6653...
    56          85               0.359            22  [{'document_id': 100, 'similarity': 0.50199585...
    57          93               0.397            22  [{'document_id': 1710864, 'similarity': 0.6655...
    58          79               0.387            21  [{'document_id': 1162084, 'similarity': 0.5723...

    5. Delete the extracted features
     DELETE http://localhost:5001/api/v0/feature-extraction/5246e3effde24f6d




|


.. code-block:: python


    import os.path
    import pandas as pd
    from time import time
    import requests

    pd.options.display.float_format = '{:,.3f}'.format


    dataset_name = "treclegal09_2k_subset"     # see list of available datasets

    BASE_URL = "http://localhost:5001/api/v0"  # FreeDiscovery server URL

    print(" 0. Load the example dataset")
    url = BASE_URL + '/example-dataset/{}'.format(dataset_name)
    print(" GET", url)
    input_ds = requests.get(url).json()

    # To use a custom dataset, simply specify the following variables
    data_dir = input_ds['metadata']['data_dir']
    dataset_definition = [{'document_id': row['document_id'],
                           'file_path': os.path.join(data_dir, row['file_path'])}
                          for row in input_ds['dataset']]

    # # 1. Feature extraction (non hashed)

    print("\n1.a Load dataset and initalize feature extraction")
    url = BASE_URL + '/feature-extraction'
    print(" POST", url)
    fe_opts = {  # 'min_df': 4, 'max_df': 0.75  # filter out (too)/(un)frequent words
               }
    res = requests.post(url, json=fe_opts).json()

    dsid = res['id']
    print("   => received {}".format(list(res.keys())))
    print("   => dsid = {}".format(dsid))


    print("\n1.b Run feature extraction")
    # progress status is available for the hashed version only
    url = BASE_URL+'/feature-extraction/{}'.format(dsid)
    print(" POST", url)
    res = requests.post(url, json={'dataset_definition': dataset_definition})

    print("\n1.d. check the parameters of the extracted features")
    url = BASE_URL + '/feature-extraction/{}'.format(dsid)
    print(' GET', url)
    res = requests.get(url).json()

    print('\n'.join(['     - {}: {}'.format(key, val) for key, val in res.items()
                     if "filenames" not in key]))

    print("\n2. Calculate LSI")

    url = BASE_URL + '/lsi/'
    print("POST", url)

    n_components = 300
    res = requests.post(url,
                        json={'n_components': n_components,
                              'parent_id': dsid
                              }).json()

    lsi_id = res['id']
    print('  => LSI model id = {}'.format(lsi_id))
    print(('  => SVD decomposition with {} dimensions '
           'explaining {:.2f} % variabilty of the data')
          .format(n_components, res['explained_variance']*100))

    # # 3. Document Clustering (LSI + K-Means)

    print("\n3.a. Document clustering (LSI + K-means)")

    url = BASE_URL + '/clustering/k-mean/'
    print(" POST", url)
    t0 = time()
    res = requests.post(url,
                        json={'parent_id': lsi_id,
                              'n_clusters': 10,
                              }).json()

    mid = res['id']
    print("     => model id = {}".format(mid))

    print("\n3.b. Computing cluster labels")
    url = BASE_URL + '/clustering/k-mean/{}'.format(mid)
    print(" GET", url)
    res = requests.get(url,
                       json={'n_top_words': 3
                             }).json()
    t1 = time()


    data = res['data']
    for row in data:
        row['n_documents'] = len(row.pop('documents'))

    print('    .. computed in {:.1f}s'.format(t1 - t0))
    print(pd.DataFrame(data))


    # # 4. Document Clustering (LSI + Birch Clustering)

    print("\n4.a. Document clustering (LSI + Birch clustering)")

    url = BASE_URL + '/clustering/birch/'
    print(" POST", url)
    t0 = time()
    res = requests.post(url,
                        json={'parent_id': lsi_id,
                              'n_clusters': -1,
                              'min_similarity': 0.7,
                              'branching_factor': 20,
                              'max_tree_depth': 2,
                              }).json()

    mid = res['id']
    print("     => model id = {}".format(mid))

    print("\n4.b. Computing cluster labels")
    url = BASE_URL + '/clustering/birch/{}'.format(mid)
    print(" GET", url)
    res = requests.get(url,
                       json={'n_top_words': 3
                             }).json()
    t1 = time()

    print('    .. computed in {:.1f}s'.format(t1 - t0))
    data = res['data']
    for row in data:
        row['n_documents'] = len(row.pop('documents'))

    print(pd.DataFrame(data))

    # # 4. Optimal sampling (LSI + Birch Clustering)

    print("\n4.a. Optimal sampling (LSI + Birch clustering)")

    t0 = time()
    url = BASE_URL + '/clustering/birch/{}'.format(mid)
    print(" GET", url)
    res = requests.get(url,
                       json={'return_optimal_sampling': True,
                             'sampling_min_coverage': 0.9
                             }).json()
    t1 = time()
    print('    .. computed in {:.1f}s'.format(t1 - t0))
    data = res['data']

    print(pd.DataFrame(data))

    # 4. Cleaning
    print("\n5. Delete the extracted features")
    url = BASE_URL + '/feature-extraction/{}'.format(dsid)
    print(" DELETE", url)
    requests.delete(url)

**Total running time of the script:** ( 0 minutes  10.668 seconds)



.. container:: sphx-glr-footer


  .. container:: sphx-glr-download

     :download:`Download Python source code: REST_clustering.py <REST_clustering.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: REST_clustering.ipynb <REST_clustering.ipynb>`

.. rst-class:: sphx-glr-signature

    `Generated by Sphinx-Gallery <http://sphinx-gallery.readthedocs.io>`_
