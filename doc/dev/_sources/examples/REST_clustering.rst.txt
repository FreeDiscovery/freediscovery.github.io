

.. _sphx_glr_examples_REST_clustering.py:


Clustering Example [REST API]
-----------------------------

Cluster documents into clusters





.. rst-class:: sphx-glr-script-out

 Out::

    0. Load the example dataset
     GET http://localhost:5001/api/v0/example-dataset/treclegal09_2k_subset

    1.a Load dataset and initalize feature extraction
     POST http://localhost:5001/api/v0/feature-extraction
       => received ['id']
       => dsid = 57ed9f6754c94dbd

    1.b Run feature extraction
     POST http://localhost:5001/api/v0/feature-extraction/57ed9f6754c94dbd

    1.d. check the parameters of the extracted features
     GET http://localhost:5001/api/v0/feature-extraction/57ed9f6754c94dbd
         - analyzer: word
         - binary: False
         - chunk_size: 5000
         - data_dir: /home/ubuntu/freediscovery_shared/treclegal09_2k_subset/data/jobRun_4/XML_EXPORT_CONTENT/text_9
         - max_df: 1.0
         - min_df: 0.0
         - n_features: 100001
         - n_jobs: 1
         - n_samples: 2465
         - n_samples_processed: 2465
         - ngram_range: [1, 1]
         - norm: l2
         - parse_email_headers: False
         - stop_words: None
         - sublinear_tf: True
         - use_hashing: False
         - use_idf: False

    2. Calculate LSI
    POST http://localhost:5001/api/v0/lsi/
      => LSI model id = 27650dd83f9142e2
      => SVD decomposition with 300 dimensions explaining 90.00 % variabilty of the data

    3.a. Document clustering (LSI + K-means)
     POST http://localhost:5001/api/v0/clustering/k-mean/
         => model id = 931a8ebd6dd44d5d

    3.b. Computing cluster labels
     GET http://localhost:5001/api/v0/clustering/k-mean/931a8ebd6dd44d5d
        .. computed in 1.4s
       cluster_id                      cluster_label  cluster_similarity  cluster_size  n_documents
    0           0                   thu normal tenet               0.188           247          247
    1           1             rewrite address server               1.000            56           56
    2           2                     tue brazil nov               0.181           214          214
    3           3              party customer master               0.156           379          379
    4           4                     wed oct normal               0.153           347          347
    5           5                   thu tiger normal               0.310           138          138
    6           6  enron_development attorney issues               0.440            54           54
    7           7              test group recipients               0.099           734          734
    8           8              mon conference normal               0.262           179          179
    9           9                      ect hou clair               0.321           117          117

    4.a. Document clustering (LSI + Birch clustering)
     POST http://localhost:5001/api/v0/clustering/birch/
         => model id = 2b3286a52c0d4edb

    4.b. Computing cluster labels
     GET http://localhost:5001/api/v0/clustering/birch/2b3286a52c0d4edb
        .. computed in 2.3s
                                                 children  cluster_depth  cluster_id                     cluster_label  cluster_similarity  cluster_size  n_documents
    0    [1, 3, 6, 8, 12, 15, 18, 21, 23, 31, 36, 54, 75]              0           0                   normal test ect               0.071          2465         2465
    1                                                 [2]              1           1            rewrite address server               0.864            65           65
    2                                                  []              2           2            rewrite address server               0.864            65           65
    3                                              [4, 5]              1           3             flynn smud shackleton               0.337            39           39
    4                                                  []              2           4                flynn smud deseret               0.405            22           22
    5                                                  []              2           5                memo marcelo flynn               0.486            17           17
    6                                                 [7]              1           6             changing place master               0.748             7            7
    7                                                  []              2           7             changing place master               0.748             7            7
    8                                         [9, 10, 11]              1           8    test recipients administrative               0.368            69           69
    9                                                  []              2           9            test budget recipients               0.559            15           15
    10                                                 []              2          10               sutton enron delete               0.514             9            9
    11                                                 []              2          11    administrative recipients test               0.405            45           45
    12                                           [13, 14]              1          12                 teneo normal load               0.459            76           76
    13                                                 []              2          13                     stack nov tue               0.495             9            9
    14                                                 []              2          14                 teneo normal load               0.488            67           67
    15                                           [16, 17]              1          15                     ect hou ellis               0.390            80           80
    16                                                 []              2          16                ect guidelines rmt               0.595            17           17
    17                                                 []              2          17                     ect hou ellis               0.419            63           63
    18                                           [19, 20]              1          18          shall agreement customer               0.355            99           99
    19                                                 []              2          19            shall agreement lessee               0.483            58           58
    20                                                 []              2          20               customer alias haas               0.402            41           41
    21                                               [22]              1          21           usvi check counterparty               0.498            18           18
    22                                                 []              2          22           usvi check counterparty               0.498            18           18
    23                       [24, 25, 26, 27, 28, 29, 30]              1          23             haedicke trade master               0.143           284          284
    24                                                 []              2          24        calo gdr enron_development               0.349            55           55
    25                                                 []              2          25            trade shackleton tiger               0.316            49           49
    26                                                 []              2          26               master southern ect               0.442            19           19
    27                                                 []              2          27               sweet twanda canada               0.303            41           41
    28                                                 []              2          28               haedicke nov normal               0.383            37           37
    29                                                 []              2          29       message enrononline working               0.312            52           52
    ..                                                ...            ...         ...                               ...                 ...           ...          ...
    50                                                 []              2          50        enron johnson transmission               0.355            24           24
    51                                                 []              2          51              ruppert exxon sprint               0.315            41           41
    52                                                 []              2          52             kincannon dead harris               0.310            53           53
    53                                                 []              2          53                    cat urine odor               0.297            34           34
    54  [55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 6...              1          54                 tenet normal test               0.108           825          825
    55                                                 []              2          55  enron_development issues bertone               0.349            68           68
    56                                                 []              2          56           dasovich bruno gaillard               0.308            52           52
    57                                                 []              2          57   kean enron_development language               0.412            38           38
    58                                                 []              2          58               wed services murray               0.304            55           55
    59                                                 []              2          59           transaction party price               0.409            60           60
    60                                                 []              2          60   confirmation transaction period               0.435            35           35
    61                                                 []              2          61              project masters stay               0.278            50           50
    62                                                 []              2          62          kitchen registration lon               0.377            26           26
    63                                                 []              2          63   market transmission electricity               0.353            24           24
    64                                                 []              2          64                     tue class oct               0.437            10           10
    65                                                 []              2          65   meeting enrononline midamerican               0.370            31           31
    66                                                 []              2          66                     gtc enron eta               0.298            56           56
    67                                                 []              2          67                 fri tenet meeting               0.409            31           31
    68                                                 []              2          68                   thu sanders oct               0.352            39           39
    69                                                 []              2          69                   credit mtm form               0.364            28           28
    70                                                 []              2          70                     thu deal cash               0.328            59           59
    71                                                 []              2          71                  mon tenet normal               0.300            54           54
    72                                                 []              2          72                     mon tenet nov               0.362            47           47
    73                                                 []              2          73                   room budget tue               0.377            24           24
    74                                                 []              2          74                     tue oct tenet               0.496            38           38
    75                                   [76, 77, 78, 79]              1          75            migration outlook team               0.213           134          134
    76                                                 []              2          76                   pcb houston fyi               0.294            30           30
    77                                                 []              2          77                     mon tenet mtg               0.337            43           43
    78                                                 []              2          78                    serc nerc said               0.390            20           20
    79                                                 []              2          79            migration outlook team               0.426            41           41

    [80 rows x 7 columns]

    4.a. Optimal sampling (LSI + Birch clustering)
     GET http://localhost:5001/api/v0/clustering/birch/2b3286a52c0d4edb
        .. computed in 0.1s
        cluster_id  cluster_similarity  cluster_size                                          documents
    0           55               0.349            68  [{'document_id': 900, 'similarity': 0.72513123...
    1           14               0.488            67  [{'document_id': 314721, 'similarity': 0.61864...
    2            2               0.864            65  [{'document_id': 5041, 'similarity': 0.9973608...
    3           17               0.419            63  [{'document_id': 11236, 'similarity': 0.795090...
    4           59               0.409            60  [{'document_id': 166464, 'similarity': 0.84868...
    5           70               0.328            59  [{'document_id': 2223081, 'similarity': 0.4860...
    6           19               0.483            58  [{'document_id': 298116, 'similarity': 0.77971...
    7           66               0.298            56  [{'document_id': 1098304, 'similarity': 0.5850...
    8           24               0.349            55  [{'document_id': 91809, 'similarity': 0.544127...
    9           58               0.304            55  [{'document_id': 3455881, 'similarity': 0.6305...
    10          71               0.300            54  [{'document_id': 3097600, 'similarity': 0.6626...
    11          52               0.310            53  [{'document_id': 28561, 'similarity': 0.591397...
    12          29               0.312            52  [{'document_id': 3381921, 'similarity': 0.5376...
    13          38               0.358            52  [{'document_id': 79524, 'similarity': 0.547196...
    14          42               0.387            52  [{'document_id': 4624, 'similarity': 0.6397189...
    15          47               0.311            52  [{'document_id': 683929, 'similarity': 0.57745...
    16          56               0.308            52  [{'document_id': 349281, 'similarity': 0.59945...
    17          48               0.387            50  [{'document_id': 4879681, 'similarity': 0.6212...
    18          61               0.278            50  [{'document_id': 341056, 'similarity': 0.43666...
    19          25               0.316            49  [{'document_id': 21025, 'similarity': 0.482801...
    20          37               0.319            48  [{'document_id': 6889, 'similarity': 0.5418342...
    21          49               0.413            47  [{'document_id': 1317904, 'similarity': 0.6414...
    22          72               0.362            47  [{'document_id': 6041764, 'similarity': 0.6574...
    23          11               0.405            45  [{'document_id': 855625, 'similarity': 0.78409...
    24          40               0.334            45  [{'document_id': 234256, 'similarity': 0.61746...
    25          77               0.337            43  [{'document_id': 2259009, 'similarity': 0.5220...
    26          44               0.274            42  [{'document_id': 1575025, 'similarity': 0.3990...
    27          20               0.402            41  [{'document_id': 628849, 'similarity': 0.78314...
    28          27               0.303            41  [{'document_id': 1437601, 'similarity': 0.4280...
    29          51               0.315            41  [{'document_id': 1664100, 'similarity': 0.6107...
    30          79               0.426            41  [{'document_id': 5322249, 'similarity': 0.6899...
    31          35               0.428            39  [{'document_id': 2673225, 'similarity': 0.6586...
    32          68               0.352            39  [{'document_id': 2430481, 'similarity': 0.6012...
    33          57               0.412            38  [{'document_id': 145924, 'similarity': 0.71273...
    34          74               0.496            38  [{'document_id': 1893376, 'similarity': 0.7419...
    35          28               0.383            37  [{'document_id': 2913849, 'similarity': 0.6223...
    36          60               0.435            35  [{'document_id': 53361, 'similarity': 0.741564...
    37          53               0.297            34  [{'document_id': 456976, 'similarity': 0.45818...
    38          39               0.369            32  [{'document_id': 697225, 'similarity': 0.60496...
    39          30               0.359            31  [{'document_id': 902500, 'similarity': 0.54081...
    40          43               0.324            31  [{'document_id': 739600, 'similarity': 0.41718...
    41          65               0.370            31  [{'document_id': 423801, 'similarity': 0.54754...
    42          67               0.409            31  [{'document_id': 3880900, 'similarity': 0.7913...
    43          76               0.294            30  [{'document_id': 921600, 'similarity': 0.54108...
    44          69               0.364            28  [{'document_id': 7569, 'similarity': 0.6608958...
    45          32               0.348            26  [{'document_id': 6051600, 'similarity': 0.6298...
    46          62               0.377            26  [{'document_id': 1032256, 'similarity': 0.5552...
    47          33               0.428            24  [{'document_id': 2876416, 'similarity': 0.7082...
    48          50               0.355            24  [{'document_id': 2076481, 'similarity': 0.6114...
    49          63               0.353            24  [{'document_id': 5531904, 'similarity': 0.4828...
    50          73               0.377            24  [{'document_id': 2402500, 'similarity': 0.6184...

    5. Delete the extracted features
     DELETE http://localhost:5001/api/v0/feature-extraction/57ed9f6754c94dbd




|


.. code-block:: python


    import os.path
    import pandas as pd
    from time import time
    import requests

    pd.options.display.float_format = '{:,.3f}'.format


    dataset_name = "treclegal09_2k_subset"     # see list of available datasets

    BASE_URL = "http://localhost:5001/api/v0"  # FreeDiscovery server URL

    print(" 0. Load the example dataset")
    url = BASE_URL + '/example-dataset/{}'.format(dataset_name)
    print(" GET", url)
    input_ds = requests.get(url).json()

    # To use a custom dataset, simply specify the following variables
    data_dir = input_ds['metadata']['data_dir']
    dataset_definition = [{'document_id': row['document_id'],
                           'file_path': os.path.join(data_dir, row['file_path'])}
                          for row in input_ds['dataset']]

    # # 1. Feature extraction (non hashed)

    print("\n1.a Load dataset and initalize feature extraction")
    url = BASE_URL + '/feature-extraction'
    print(" POST", url)
    fe_opts = {  # 'min_df': 4, 'max_df': 0.75  # filter out (too)/(un)frequent words
               }
    res = requests.post(url, json=fe_opts).json()

    dsid = res['id']
    print("   => received {}".format(list(res.keys())))
    print("   => dsid = {}".format(dsid))


    print("\n1.b Run feature extraction")
    # progress status is available for the hashed version only
    url = BASE_URL+'/feature-extraction/{}'.format(dsid)
    print(" POST", url)
    res = requests.post(url, json={'dataset_definition': dataset_definition})

    print("\n1.d. check the parameters of the extracted features")
    url = BASE_URL + '/feature-extraction/{}'.format(dsid)
    print(' GET', url)
    res = requests.get(url).json()

    print('\n'.join(['     - {}: {}'.format(key, val) for key, val in res.items()
                     if "filenames" not in key]))

    print("\n2. Calculate LSI")

    url = BASE_URL + '/lsi/'
    print("POST", url)

    n_components = 300
    res = requests.post(url,
                        json={'n_components': n_components,
                              'parent_id': dsid
                              }).json()

    lsi_id = res['id']
    print('  => LSI model id = {}'.format(lsi_id))
    print(('  => SVD decomposition with {} dimensions '
           'explaining {:.2f} % variabilty of the data')
          .format(n_components, res['explained_variance']*100))

    # # 3. Document Clustering (LSI + K-Means)

    print("\n3.a. Document clustering (LSI + K-means)")

    url = BASE_URL + '/clustering/k-mean/'
    print(" POST", url)
    t0 = time()
    res = requests.post(url,
                        json={'parent_id': lsi_id,
                              'n_clusters': 10,
                              }).json()

    mid = res['id']
    print("     => model id = {}".format(mid))

    print("\n3.b. Computing cluster labels")
    url = BASE_URL + '/clustering/k-mean/{}'.format(mid)
    print(" GET", url)
    res = requests.get(url,
                       json={'n_top_words': 3
                             }).json()
    t1 = time()


    data = res['data']
    for row in data:
        row['n_documents'] = len(row.pop('documents'))

    print('    .. computed in {:.1f}s'.format(t1 - t0))
    print(pd.DataFrame(data))


    # # 4. Document Clustering (LSI + Birch Clustering)

    print("\n4.a. Document clustering (LSI + Birch clustering)")

    url = BASE_URL + '/clustering/birch/'
    print(" POST", url)
    t0 = time()
    res = requests.post(url,
                        json={'parent_id': lsi_id,
                              'n_clusters': -1,
                              'min_similarity': 0.7,
                              'branching_factor': 20,
                              'max_tree_depth': 2,
                              }).json()

    mid = res['id']
    print("     => model id = {}".format(mid))

    print("\n4.b. Computing cluster labels")
    url = BASE_URL + '/clustering/birch/{}'.format(mid)
    print(" GET", url)
    res = requests.get(url,
                       json={'n_top_words': 3
                             }).json()
    t1 = time()

    print('    .. computed in {:.1f}s'.format(t1 - t0))
    data = res['data']
    for row in data:
        row['n_documents'] = len(row.pop('documents'))

    print(pd.DataFrame(data))

    # # 4. Optimal sampling (LSI + Birch Clustering)

    print("\n4.a. Optimal sampling (LSI + Birch clustering)")

    t0 = time()
    url = BASE_URL + '/clustering/birch/{}'.format(mid)
    print(" GET", url)
    res = requests.get(url,
                       json={'return_optimal_sampling': True,
                             'sampling_min_coverage': 0.9
                             }).json()
    t1 = time()
    print('    .. computed in {:.1f}s'.format(t1 - t0))
    data = res['data']

    print(pd.DataFrame(data))

    # 4. Cleaning
    print("\n5. Delete the extracted features")
    url = BASE_URL + '/feature-extraction/{}'.format(dsid)
    print(" DELETE", url)
    requests.delete(url)

**Total running time of the script:** ( 0 minutes  14.025 seconds)



.. container:: sphx-glr-footer


  .. container:: sphx-glr-download

     :download:`Download Python source code: REST_clustering.py <REST_clustering.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: REST_clustering.ipynb <REST_clustering.ipynb>`

.. rst-class:: sphx-glr-signature

    `Generated by Sphinx-Gallery <http://sphinx-gallery.readthedocs.io>`_
